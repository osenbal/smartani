import { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import {
  dbRefMoisture,
  dbRefUserSuggestion,
  dbRefWatering,
  updateWatering,
} from '@/data/firebaseApp';
import { useContextAuth } from '@/hooks/useContextAuth';
import { onValue } from 'firebase/database';
import { useLand } from '@/hooks/land/useLand';
import AsyncImage from '@/ui/components/AsyncImage';

const DetailLahanPage = () => {
  const { user } = useContextAuth();
  const { getLandById } = useLand();
  const { lahanId } = useParams();
  const [land, setLand] = useState<ILand | null>(null);
  const [moisture, setMoisture] = useState<number>(0);
  const [suggestion, setSuggestion] = useState<string>('');
  const [isWatering, setIsWatering] = useState<boolean>(false);

  const navigate = useNavigate();

  const handleBack = () => {
    navigate(-1);
  };

  const handleWatering = () => {
    const uid = user?.uid;
    if (uid != null) {
      updateWatering(uid, !isWatering);
    }
  };

  useEffect(() => {
    const uid = user?.uid;
    if (uid != null) {
      onValue(dbRefMoisture(uid), (snapshot) => {
        const data = snapshot.val();
        if (!!data) {
          setMoisture(data);
        }
      });

      onValue(dbRefUserSuggestion(uid), (snapshot) => {
        const data = snapshot.val();
        console.log(data);
        if (!!data) {
          setSuggestion(data);
        }
      });

      onValue(dbRefWatering(uid), (snapshot) => {
        const data = snapshot.val();
        if (!!data) {
          setIsWatering(data);
        } else {
          setIsWatering(false);
        }
      });
    }
  }, []);

  useEffect(() => {
    if (lahanId) {
      getLandById(Number(lahanId)).then((res) => {
        setLand(res.data);
        console.log(res.data);
      });
    }
  }, [lahanId]);

  console.log(land);

  return (
    <>
      <div className="flex justify-start bg-white p-2  rounded-b-md">
        <div
          className="p-2 cursor-pointer hover:bg-slate-200 rounded-md"
          onClick={handleBack}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="34"
            height="24"
            viewBox="0 0 34 24"
            fill="none"
          >
            <path
              d="M29 12H5"
              stroke="#2E2E2E"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            />
            <path
              d="M12 19L5 12L12 5"
              stroke="#2E2E2E"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
            />
          </svg>
        </div>
      </div>
      <div className="relative pb-[210px] px-[25px] overflow-hidden">
        <div className="flex flex-row mt-3 justify-between gap-3 items-center">
          <p className="text-subTitle2 uppercase flex-1">{land?.name ?? '-'}</p>

          <div className="cursor-pointer hover:bg-slate-200 p-2 rounded-md">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
            >
              <path
                d="M10.001 7.80005C9.71196 7.80005 9.42575 7.85698 9.15872 7.96759C8.89168 8.0782 8.64904 8.24033 8.44466 8.44471C8.24028 8.64909 8.07815 8.89172 7.96754 9.15876C7.85693 9.4258 7.8 9.71201 7.8 10.001C7.8 10.2901 7.85693 10.5763 7.96754 10.8433C8.07815 11.1104 8.24028 11.353 8.44466 11.5574C8.64904 11.7618 8.89168 11.9239 9.15872 12.0345C9.42575 12.1451 9.71196 12.202 10.001 12.202C10.5847 12.2019 11.1445 11.9699 11.5572 11.557C11.9699 11.1442 12.2016 10.5843 12.2015 10.0005C12.2014 9.41681 11.9694 8.85703 11.5565 8.44435C11.1436 8.03168 10.5837 7.79992 10 7.80005H10.001ZM10.001 5.20005C10.2899 5.19992 10.576 5.14288 10.8428 5.0322C11.1097 4.92152 11.3521 4.75936 11.5563 4.55498C11.7605 4.3506 11.9225 4.108 12.0329 3.84103C12.1434 3.57406 12.2001 3.28796 12.2 2.99905C12.1999 2.71014 12.1428 2.42409 12.0322 2.15722C11.9215 1.89036 11.7593 1.6479 11.5549 1.44371C11.3505 1.23951 11.1079 1.07757 10.841 0.967131C10.574 0.856692 10.2879 0.799918 9.999 0.800049C9.41553 0.800314 8.85605 1.03235 8.44366 1.44512C8.03127 1.85789 7.79974 2.41757 7.8 3.00105C7.80027 3.58453 8.03231 4.144 8.44508 4.55639C8.85784 4.96878 9.41753 5.20031 10.001 5.20005ZM10.001 14.8C9.41726 14.8 8.85743 15.0319 8.44466 15.4447C8.03189 15.8575 7.8 16.4173 7.8 17.001C7.8 17.5848 8.03189 18.1446 8.44466 18.5574C8.85743 18.9702 9.41726 19.202 10.001 19.202C10.5847 19.202 11.1446 18.9702 11.5573 18.5574C11.9701 18.1446 12.202 17.5848 12.202 17.001C12.202 16.4173 11.9701 15.8575 11.5573 15.4447C11.1446 15.0319 10.5847 14.8 10.001 14.8Z"
                fill="#4F4F4F"
              />
            </svg>
          </div>
        </div>

        <AsyncImage
          errorImageClassNames="rounded-2xl mt-3 h-[224px] "
          className="w-full h-[224px] object-cover rounded-2xl mt-3"
          src={land?.imageUrl ?? 'https://picsum.photos/200/300'}
          alt="garden"
        />

        <div className="flex flex-row justify-between items-start flex-wrap mt-3 gap-3">
          <div className="flex flex-col">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
            >
              <path
                d="M20 2H4C2.9 2 2 2.9 2 4V20C2 21.1 2.9 22 4 22H20C21.1 22 22 21.1 22 20V4C22 2.9 21.1 2 20 2ZM4 4H8V14H4V4ZM4 20V16H8V20H4ZM20 20H10V10H20V20ZM20 8H10V4H20V8Z"
                fill="#4F4F4F"
              />
            </svg>
            <p className="text-[0.875em] font-semibold">
              {land?.wide && land?.length
                ? `${land?.wide}m x ${land?.length}m`
                : '-'}
            </p>
            <span className="text-[0.75em] font-medium">Luas Lahan</span>
          </div>

          <div className="flex flex-col">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
            >
              <path
                d="M12.4275 2.81823C12.3747 2.75656 12.3092 2.70705 12.2354 2.6731C12.1617 2.63916 12.0814 2.62158 12.0002 2.62158C11.919 2.62158 11.8388 2.63916 11.7651 2.6731C11.6913 2.70705 11.6258 2.75656 11.573 2.81823C10.0889 4.55401 5.25 10.5549 5.25 15.0001C5.25 19.1424 7.85812 21.7501 12 21.7501C16.1419 21.7501 18.75 19.1424 18.75 15.0001C18.75 10.5549 13.9111 4.55401 12.4275 2.81823ZM12.75 19.3126C12.6599 19.3128 12.5711 19.2914 12.491 19.2501C12.4109 19.2088 12.3419 19.1489 12.2898 19.0754C12.2377 19.0019 12.2041 18.9169 12.1916 18.8277C12.1792 18.7385 12.1884 18.6475 12.2184 18.5626C12.2568 18.4518 12.3291 18.3559 12.4252 18.2885C12.5212 18.2212 12.636 18.1859 12.7533 18.1876C13.4978 18.186 14.2114 17.8895 14.7379 17.363C15.2644 16.8365 15.5609 16.1229 15.5625 15.3784C15.5608 15.2611 15.5961 15.1463 15.6634 15.0503C15.7308 14.9542 15.8267 14.8819 15.9375 14.8435C16.0224 14.8135 16.1134 14.8043 16.2026 14.8167C16.2918 14.8292 16.3768 14.8628 16.4503 14.9149C16.5238 14.967 16.5837 15.036 16.625 15.1161C16.6663 15.1962 16.6877 15.285 16.6875 15.3751C16.6864 16.419 16.2712 17.4199 15.533 18.1581C14.7948 18.8963 13.7939 19.3115 12.75 19.3126Z"
                fill="#4F4F4F"
              />
            </svg>
            <p className="text-[0.875em] font-semibold">{moisture}/100</p>
            <span className="text-[0.75em] font-medium">
              Kelembapan <br /> tanah
            </span>
          </div>
          <div className="flex flex-col">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
            >
              <path
                d="M14.863 13.4001V4.9391C14.857 4.17907 14.5558 3.45115 14.023 2.9091C13.7318 2.62053 13.382 2.39795 12.9972 2.25647C12.6125 2.11499 12.2018 2.05791 11.793 2.0891C11.053 2.16155 10.3678 2.51094 9.87448 3.06726C9.3812 3.62359 9.11636 4.34576 9.13302 5.0891L9.14301 13.3691C8.41084 13.919 7.85302 14.6687 7.53659 15.528C7.22015 16.3872 7.15856 17.3196 7.35922 18.2131C7.55987 19.1065 8.01424 19.923 8.66772 20.5645C9.3212 21.2059 10.146 21.6451 11.043 21.8291C11.3562 21.8888 11.6742 21.9189 11.993 21.9191C13.2538 21.9194 14.4632 21.4193 15.3556 20.5288C16.248 19.6382 16.7506 18.4299 16.753 17.1691C16.7545 16.4369 16.5843 15.7145 16.2561 15.0599C15.9278 14.4054 15.4507 13.8369 14.863 13.4001ZM14.383 20.0601C13.9487 20.4156 13.4407 20.6701 12.8959 20.805C12.3511 20.9399 11.783 20.9519 11.233 20.8401C10.503 20.6947 9.83387 20.3326 9.31293 19.8009C8.792 19.2693 8.44352 18.5929 8.31301 17.8601C8.18302 17.1729 8.24807 16.463 8.50081 15.8108C8.75354 15.1586 9.18386 14.5903 9.74301 14.1701C9.8635 14.081 9.96151 13.965 10.0292 13.8313C10.0969 13.6976 10.1325 13.55 10.133 13.4001V5.0891C10.1215 4.60041 10.2923 4.12493 10.612 3.75523C10.9318 3.38553 11.3778 3.14808 11.863 3.0891C11.9092 3.0808 11.9561 3.07745 12.003 3.0791C12.4949 3.08379 12.9652 3.28126 13.313 3.62907C13.6609 3.97687 13.8583 4.44725 13.863 4.9391V13.4001C13.8636 13.55 13.8991 13.6976 13.9668 13.8313C14.0345 13.965 14.1325 14.081 14.253 14.1701C14.7075 14.5102 15.0786 14.9493 15.3383 15.454C15.598 15.9587 15.7395 16.5159 15.752 17.0834C15.7645 17.6509 15.6478 18.2139 15.4106 18.7296C15.1734 19.2453 14.822 19.7003 14.383 20.0601Z"
                fill="#4F4F4F"
              />
              <path
                d="M13.893 17.1689C13.893 17.6702 13.6939 18.1509 13.3394 18.5053C12.985 18.8598 12.5043 19.0589 12.003 19.0589C11.5018 19.0589 11.021 18.8598 10.6666 18.5053C10.3121 18.1509 10.113 17.6702 10.113 17.1689C10.1104 16.7556 10.2456 16.3532 10.4974 16.0253C10.7491 15.6975 11.103 15.463 11.503 15.3589V5.3999C11.503 5.26729 11.5557 5.14012 11.6495 5.04635C11.7432 4.95258 11.8704 4.8999 12.003 4.8999C12.1356 4.8999 12.2628 4.95258 12.3566 5.04635C12.4503 5.14012 12.503 5.26729 12.503 5.3999V15.3599C12.9019 15.4657 13.2546 15.7005 13.506 16.0277C13.7575 16.355 13.8935 16.7562 13.893 17.1689Z"
                fill="#4F4F4F"
              />
            </svg>
            <p className="text-[0.875em] font-semibold">33° C</p>
            <span className="text-[0.75em] font-medium">Suhu Cuaca</span>
          </div>
        </div>

        <div className="flex flex-row bg-white justify-between p-4 rounded-xl mt-10">
          <div className="flex flex-row flex-1 items-center justify-start gap-4">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 16 16"
              fill="none"
            >
              <path
                d="M2 2.4C2 2.29391 2.04214 2.19217 2.11716 2.11716C2.19217 2.04214 2.29391 2 2.4 2H13.6C13.7061 2 13.8078 2.04214 13.8828 2.11716C13.9579 2.19217 14 2.29391 14 2.4V11.6C14 11.6525 13.9897 11.7045 13.9696 11.7531C13.9495 11.8016 13.92 11.8457 13.8828 11.8828C13.8457 11.92 13.8016 11.9495 13.7531 11.9696C13.7045 11.9897 13.6525 12 13.6 12H10.84C10.7853 11.9999 10.7312 12.0111 10.6809 12.0327C10.6307 12.0544 10.5855 12.0861 10.548 12.126L8.29133 14.524C8.25393 14.5638 8.20879 14.5954 8.15869 14.6171C8.10859 14.6387 8.05458 14.6499 8 14.6499C7.94542 14.6499 7.89141 14.6387 7.84131 14.6171C7.79121 14.5954 7.74607 14.5638 7.70867 14.524L5.452 12.126C5.41453 12.0861 5.36928 12.0544 5.31906 12.0327C5.26884 12.0111 5.2147 11.9999 5.16 12H2.4C2.29391 12 2.19217 11.9579 2.11716 11.8828C2.04214 11.8078 2 11.7061 2 11.6V2.4Z"
                stroke="#DB5B23"
                stroke-width="1.5"
              />
              <path
                d="M7.99999 4.66675L8.95 6.38341L10.6667 7.33341L8.95 8.28341L7.99999 10.0001L7.04999 8.28341L5.33333 7.33341L7.04999 6.38341L7.99999 4.66675Z"
                stroke="#DB5B23"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <p className="text-body2Semibold">{suggestion || '-'}</p>
          </div>

          <div className="flex flex-col items-center justify-center">
            <div
              onClick={handleWatering}
              className="cursor-pointer hover:bg-slate-100 rounded-md transition-all duration-200 ease-linear"
            >
              {isWatering ? (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="130"
                  height="130"
                  viewBox="0 0 130 130"
                  fill="none"
                >
                  <g filter="url(#filter0_d_166_133)">
                    <path
                      d="M65 64.9999C63.4653 64.9999 62.1797 64.4799 61.1433 63.4399C60.1069 62.3999 59.5869 61.1144 59.5833 59.5833V16.2499C59.5833 14.7152 60.1033 13.4296 61.1433 12.3933C62.1833 11.3569 63.4689 10.8369 65 10.8333C66.5347 10.8333 67.8221 11.3533 68.8621 12.3933C69.9021 13.4333 70.4203 14.7188 70.4167 16.2499V59.5833C70.4167 61.118 69.8967 62.4053 68.8567 63.4453C67.8167 64.4853 66.5311 65.0035 65 64.9999ZM65 113.75C58.2292 113.75 51.8881 112.464 45.9767 109.893C40.0653 107.322 34.9194 103.846 30.5392 99.4662C26.1589 95.0859 22.6832 89.9401 20.1121 84.0287C17.541 78.1173 16.2536 71.7744 16.25 64.9999C16.25 59.493 17.1528 54.1431 18.9583 48.9503C20.7639 43.7576 23.3819 38.9963 26.8125 34.6666C27.8056 33.4027 29.0694 32.7942 30.6042 32.8412C32.1389 32.8881 33.4931 33.4966 34.6667 34.6666C35.6597 35.6596 36.1111 36.8784 36.0208 38.3228C35.9306 39.7673 35.434 41.1214 34.5312 42.3853C32.0937 45.6353 30.2431 49.2013 28.9792 53.0833C27.7153 56.9652 27.0833 60.9374 27.0833 64.9999C27.0833 75.5624 30.7631 84.5234 38.1225 91.8828C45.4819 99.2423 54.4411 102.92 65 102.917C75.5625 102.917 84.5235 99.2387 91.8829 91.8828C99.2424 84.527 102.92 75.566 102.917 64.9999C102.917 60.8471 102.308 56.8063 101.091 52.8774C99.8743 48.9485 97.955 45.3609 95.3333 42.1145C94.4306 40.9409 93.934 39.6553 93.8438 38.2578C93.7535 36.8603 94.2049 35.6633 95.1979 34.6666C96.2813 33.5833 97.5903 33.0199 99.125 32.9766C100.66 32.9333 101.924 33.4966 102.917 34.6666C106.437 38.9999 109.124 43.7395 110.977 48.8853C112.829 54.0312 113.754 59.4027 113.75 64.9999C113.75 71.7708 112.464 78.1137 109.893 84.0287C107.322 89.9437 103.847 95.0895 99.4663 99.4662C95.086 103.843 89.9401 107.319 84.0287 109.893C78.1174 112.468 71.7744 113.754 65 113.75Z"
                      fill="#4169E1"
                    />
                  </g>
                  <defs>
                    <filter
                      id="filter0_d_166_133"
                      x="10.95"
                      y="7.53325"
                      width="108.1"
                      height="113.517"
                      filterUnits="userSpaceOnUse"
                      color-interpolation-filters="sRGB"
                    >
                      <feFlood flood-opacity="0" result="BackgroundImageFix" />
                      <feColorMatrix
                        in="SourceAlpha"
                        type="matrix"
                        values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
                        result="hardAlpha"
                      />
                      <feOffset dy="2" />
                      <feGaussianBlur stdDeviation="2.65" />
                      <feComposite in2="hardAlpha" operator="out" />
                      <feColorMatrix
                        type="matrix"
                        values="0 0 0 0 0.254902 0 0 0 0 0.411765 0 0 0 0 0.882353 0 0 0 0.5 0"
                      />
                      <feBlend
                        mode="normal"
                        in2="BackgroundImageFix"
                        result="effect1_dropShadow_166_133"
                      />
                      <feBlend
                        mode="normal"
                        in="SourceGraphic"
                        in2="effect1_dropShadow_166_133"
                        result="shape"
                      />
                    </filter>
                  </defs>
                </svg>
              ) : (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="130"
                  height="130"
                  viewBox="0 0 130 130"
                  fill="none"
                >
                  <path
                    d="M65 64.9999C63.4653 64.9999 62.1797 64.4799 61.1433 63.4399C60.1069 62.3999 59.5869 61.1144 59.5833 59.5833V16.2499C59.5833 14.7152 60.1033 13.4296 61.1433 12.3933C62.1833 11.3569 63.4689 10.8369 65 10.8333C66.5347 10.8333 67.8221 11.3533 68.8621 12.3933C69.9021 13.4333 70.4203 14.7188 70.4167 16.2499V59.5833C70.4167 61.118 69.8967 62.4053 68.8567 63.4453C67.8167 64.4853 66.5311 65.0035 65 64.9999ZM65 113.75C58.2292 113.75 51.8881 112.464 45.9767 109.893C40.0653 107.322 34.9194 103.846 30.5392 99.4662C26.1589 95.0859 22.6832 89.9401 20.1121 84.0287C17.541 78.1173 16.2536 71.7744 16.25 64.9999C16.25 59.493 17.1528 54.1431 18.9583 48.9503C20.7639 43.7576 23.3819 38.9963 26.8125 34.6666C27.8056 33.4027 29.0694 32.7942 30.6042 32.8412C32.1389 32.8881 33.4931 33.4966 34.6667 34.6666C35.6597 35.6596 36.1111 36.8784 36.0208 38.3228C35.9306 39.7673 35.434 41.1214 34.5312 42.3853C32.0937 45.6353 30.2431 49.2013 28.9792 53.0833C27.7153 56.9652 27.0833 60.9374 27.0833 64.9999C27.0833 75.5624 30.7631 84.5234 38.1225 91.8828C45.4819 99.2423 54.4411 102.92 65 102.917C75.5625 102.917 84.5235 99.2387 91.8829 91.8828C99.2424 84.527 102.92 75.566 102.917 64.9999C102.917 60.8471 102.308 56.8063 101.091 52.8774C99.8743 48.9485 97.955 45.3609 95.3333 42.1145C94.4306 40.9409 93.934 39.6553 93.8438 38.2578C93.7535 36.8603 94.2049 35.6633 95.1979 34.6666C96.2813 33.5833 97.5903 33.0199 99.125 32.9766C100.66 32.9333 101.924 33.4966 102.917 34.6666C106.437 38.9999 109.124 43.7395 110.977 48.8853C112.829 54.0312 113.754 59.4027 113.75 64.9999C113.75 71.7708 112.464 78.1137 109.893 84.0287C107.322 89.9437 103.847 95.0895 99.4663 99.4662C95.086 103.843 89.9401 107.319 84.0287 109.893C78.1174 112.468 71.7744 113.754 65 113.75Z"
                    fill="#4F4F4F"
                  />
                </svg>
              )}
            </div>

            <span>{isWatering ? 'Menyiram...' : 'Siram'}</span>
          </div>
        </div>
      </div>
    </>
  );
};

export default DetailLahanPage;
